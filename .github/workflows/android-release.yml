# VaultStadio Android Release Build
# Builds signed Android APKs and AABs for release
# Runner: self-hosted macOS X64

name: Android Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Build environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  JAVA_VERSION: '17'
  JAVA_DISTRIBUTION: 'temurin'

jobs:
  build-android:
    name: Build Android Release
    runs-on: [self-hosted, macOS, X64]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
      
      - name: Decode Keystore
        if: ${{ github.event_name == 'push' || inputs.environment == 'prod' }}
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > compose-frontend/keystores/release.keystore
          echo "storeFile=../keystores/release.keystore" > compose-frontend/androidApp/keystore.properties
          echo "storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> compose-frontend/androidApp/keystore.properties
          echo "keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}" >> compose-frontend/androidApp/keystore.properties
          echo "keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}" >> compose-frontend/androidApp/keystore.properties
      
      - name: Determine build variant
        id: variant
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "flavor=Prod" >> $GITHUB_OUTPUT
            echo "signed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ inputs.environment }}" == "prod" ]]; then
            echo "flavor=Prod" >> $GITHUB_OUTPUT
            echo "signed=true" >> $GITHUB_OUTPUT
          elif [[ "${{ inputs.environment }}" == "staging" ]]; then
            echo "flavor=Staging" >> $GITHUB_OUTPUT
            echo "signed=false" >> $GITHUB_OUTPUT
          else
            echo "flavor=Dev" >> $GITHUB_OUTPUT
            echo "signed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Build Release APK
        run: |
          ./gradlew :compose-frontend:androidApp:assemble${{ steps.variant.outputs.flavor }}Release
      
      - name: Build Release AAB (for Play Store)
        if: ${{ steps.variant.outputs.signed == 'true' }}
        run: |
          ./gradlew :compose-frontend:androidApp:bundle${{ steps.variant.outputs.flavor }}Release
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ steps.variant.outputs.flavor }}
          path: compose-frontend/androidApp/build/outputs/apk/**/release/*.apk
          retention-days: 30
      
      - name: Upload AAB
        uses: actions/upload-artifact@v4
        if: ${{ steps.variant.outputs.signed == 'true' }}
        with:
          name: android-aab-${{ steps.variant.outputs.flavor }}
          path: compose-frontend/androidApp/build/outputs/bundle/**/release/*.aab
          retention-days: 30
      
      - name: Upload to GitHub Release
        if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v1
        with:
          files: |
            compose-frontend/androidApp/build/outputs/apk/**/release/*.apk
            compose-frontend/androidApp/build/outputs/bundle/**/release/*.aab

  notify:
    name: Notify Build Status
    runs-on: [self-hosted, macOS, X64]
    needs: [build-android]
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.build-android.result }}" == "success" ]]; then
            echo "✅ Build completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Build failed" >> $GITHUB_STEP_SUMMARY
          fi
